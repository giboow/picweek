{% extends "PicweekMainBundle::layout.html.twig" %}

{% block stylesheets %}
    {{ parent() }}
    <style type="text/css">
        #gmap{
            width : 400px;
            height: 300px;
        }

        #search{
            border : solid 1px blue;
            width: 300px;
            height: 20px;
            padding:5px;
        }

        #search #location{
            display : inline;
        }

        #search #distance{
            float:right;
            width: 75px;
            background: white;
        }

        #search #distance .name{
            text-align: center;
            border-top: solid 1px;
            border-left: solid 1px;
            border-right: solid 1px;
            border-color:transparent;
            -webkit-border-top-left-radius: 5px;
            -webkit-border-top-right-radius: 5px;
            -moz-border-radius-topleft: 5px;
            -moz-border-radius-topright: 5px;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            padding-bottom:2px;
        }

        #search #distance .select .title{
            font-weight: bold;
        }

        #search #distance .select{
            background: white;
            position : absolute;
            border : solid 1px;
            border-color:transparent;
            border-top : none;
            width: 150px;
            margin-left:-77px;
            -webkit-border-radius: 5px;
            -webkit-border-top-right-radius: 0;
            -moz-border-radius: 5px;
            -moz-border-radius-topright: 0;
            border-radius: 5px;
            border-top-right-radius: 0;
            display: none;
        }

        #search #distance div{
            margin-left:10px;
        }

        #search #help-search{
            border: solid 1px red;
            display: none;
            position : absolute;
            background: white;
        }

        #search #distance .border-middle{
            margin:0px;
            border-top:solid 1px transparent;
            border-color:transparent;
            width: 87px;
            height:3px;
            -webkit-border-top-left-radius: 5px;
            -moz-border-radius-topleft: 5px;
            border-top-left-radius: 5px;
        }

    </style>
{% endblock %}

{% block headJavascripts %}
    {{ parent() }}
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" >
    $(document).ready(function(){
        initInterfacesActions();
    });

    function initInterfacesActions()
    {
        $("input[name=location]").click(function(){
            $("#help-search").fadeIn(500);
        });

        $("#help-search div").click(function(){
            if ($(this).attr("id") == "actual") {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position){
                        var location = new google.maps.LatLng(
                            position.coords.latitude, position.coords.longitude, false
                        );
                        var geocoder = new google.maps.Geocoder();
                        geocoder.geocode({'location': location}, function(result, status){
                            result = result[1];
                            var address = result.formatted_address;
                            $("#search input[name=location]").val(address);
                        });
                    });
                }
            }
        });

        $('#search #distance').hover(
            function(){

                $(this).children(".select").stop(true).fadeIn(500);
                $(this).children("div").css('border-color', '#CCCBD2');
                $(this).children(".select").children('div').css('border-color', '#CCCBD2');
            },
            function(){

                $(this).children("div").css('border-color', 'transparent');
                $(this).children(".select").children('div').css('border-color', 'transparent');
                $(this).children(".select").stop(true).fadeOut(200);
            }
        );

        $('#search #distance input[type=radio]').change(function(){
            $('#search #distance .name').html($(this).val()+' km');
        });


        $( "#search #location input:text" ).autocomplete({
            minLength: 2,
            source: function(request, response){
                var r = request.term;

                var geocoder = new google.maps.Geocoder();
                geocoder.geocode({'address' : r}, function(results, status){
                    if(status !== google.maps.GeocoderStatus.OK) {
                        response([]);
                        return;
                    }
                    response($.map(results, function(item) {
                        return {
                          label: item.formatted_address, // appears in dropdown box
                          value: item.formatted_address, // inserted into input element when selected
                          geocode: item,                  // all geocode data
                        };
                      }
                    ));
                });
            },
            focus : function(event, ui){
                console.log(event);
            },
            appendTo : "#help-search",
            position: { offset: "0 +25" }
        });
    }

    function getPlaces(){
        var positionCenter = new google.maps.LatLng("47", "2");
        var zoom = 6;

        var map = new google.maps.Map(
            document.getElementById('gmap'), {
                center: positionCenter,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                streetViewControl: false,
                panControl: false,
                zoom: zoom,
            }
        );


        // Récupération des emplacements aux alentours
        var openInfoWindow = new Array();
        $.ajax("{{ path("_place_map_ajax", {"address" : "lyon", "radius" : 1000})|raw }}",{
            dataType : "json",
        }).success(function(datas) {
            //var distances = datas.dits;
            var places = datas.places;
            $.each(places, function(index, place) {
                 var positionPlace = new google.maps.LatLng(place.latitude, place.longitude);
                 var marker = new google.maps.Marker({
                     map: map,
                     position: positionPlace,
                 });
                 var infowindow = new google.maps.InfoWindow();
                 infowindow.setContent(
                     "<a href=\""+url+"\">"+"{{ url('_welcome')}}place/get/"+place.id+"</a>"
                 );

                 google.maps.event.addListener(marker, 'click', function() {
                     //fermeture des infos windows déjà ouvertes
                     $.each(openInfoWindow, function(index, iw) {
                        iw.close();
                     });
                     infowindow.open(map, marker);
                     openInfoWindow.push(infowindow);
                 });
            });
        });

        return;
    }
    </script>
{% endblock     %}

{% block content %}
    <div id="search">
        <div id="main-search">
            <div id="distance">
                <div class="name">10 km</div>
                <div class="select">
                    <div class="border-middle"></div>
                    <div class="title">Distance max:</div>
                    <div>10km <input type="radio" name="distance" value="10" checked="checked"/></div>
                    <div>30km <input type="radio" name="distance" value="30"/></div>
                </div>
            </div>

            <div id="location">
                <input type="text" name="location">
            </div>
            <div class="clear"></div>
        </div>
        <div id="help-search">
            <div id="actual">Lieu actuel</div>
        </div>
    </div>
    <div id="gmap"></div>
{% endblock %}
